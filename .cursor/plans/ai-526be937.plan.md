<!-- 526be937-7f13-422c-bab9-1d0bd9ecedf0 73d89aa7-0d51-4e20-abea-c9f01b69ef62 -->
# EPIC: Transparent AI Post Generation + Scheduling + Autopilot

## Scope

- Build a trustworthy AI workflow with visible grounding, strict guardrails, and reliable scheduling that supports manual, assisted, and autopilot paths.
- Replace silent background generation with a dedicated generator page and event log.

## Key Routes & Files (Next.js App Router)

- UI
  - `apps/web/src/app/(dashboard)/locations/[locationId]/posts/new/page.tsx` (tabs: Compose | Generate with AI | Grounding | Policy Check)
  - `apps/web/src/app/(dashboard)/content/page.tsx` (approval queue)
- Server actions & APIs
  - `apps/web/src/app/(dashboard)/locations/[locationId]/posts/new/actions.ts` (startPostGeneration, approve/schedule)
  - `apps/web/src/app/api/automation/generate-posts/route.ts` (background worker trigger / status fetch)
- Core AI
  - `packages/core/src/prompts/post.ts`, `packages/core/src/ai/*` (schemas, service)

## Data Model (Supabase)

- State machines (authoritative)
  - `ai_generations.status`: pending → running → completed | moderated | failed
  - `post_candidates.status`: pending_review → approved → scheduled → published | rejected | archived
  - `schedules.status`: pending → publishing → published | failed → retrying → dead_letter
- Columns to add
  - `ai_generations`: `status text`, `idempotency_key text unique`, `retries int default 0`, `response_id text`, `risk_score float`, `costs float default 0`, `last_error text`, `meta jsonb`
  - `post_candidates`: `status text`, `idempotency_key text unique`, `schema jsonb not null`, `images jsonb not null default '[]'`
  - `schedules`: `status text`, `idempotency_key text unique`, `retries int default 0`, `next_attempt_at timestamptz`, `last_error text`, `published_at timestamptz`
- New tables
  - `ai_generation_events` (event log)
  - Optional `optimization_insights` (GBP audit)

## Example Migration Snippet

```sql
create table if not exists ai_generation_events (
  id uuid primary key default gen_random_uuid(),
  org_id uuid not null references orgs(id) on delete cascade,
  location_id uuid not null references gbp_locations(id) on delete cascade,
  generation_id uuid not null references ai_generations(id) on delete cascade,
  level text not null check (level in ('info','warn','error')),
  message text not null,
  meta jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now()
);
alter table ai_generation_events enable row level security;
create policy "read own org events" on ai_generation_events for select using (
  org_id in (select auth.user_org_ids())
);
```

## Guardrails & Validation

- zod-validate all prompt inputs/outputs; persist the validated JSON in `post_candidates.schema`.
- Pre-publish gate: moderation, GBP policy checks, `risk_score <= automation_policies.risk_threshold`, required fields, quiet hours, `max_per_week` caps.

## Generation Flow (Transparent)

1. Button “Generate with AI” navigates to `.../posts/new?mode=ai`.
2. `startPostGeneration` inserts `ai_generations(pending)` + `idempotency_key`, returns `generationId`.
3. Background worker transitions to `running`, calls `@localspotlight/core`, logs progress to `ai_generation_events`.
4. On success: create `post_candidates`, set `ai_generations.status = completed|moderated`.
5. UI polls or subscribes to events; shows grounding, model, retries, moderation, risk, policy findings, and JSON output.

## Scheduler & Autopilot

- Cron (every 5 min): `SELECT ... FOR UPDATE SKIP LOCKED` on `schedules` due; set → publishing; publish via adapter A (GBP API) else B (manual assist); exponential backoff; per-org circuit breaker; dead-letter after max retries.
- Planners: create briefs/candidates per cadence and guardrails.

## Security & RLS

- All new tables include `org_id` with org isolation RLS; role checks: `owner|admin|editor` for generate/publish.

## Testing (DoD)

- Unit: schemas, risk scoring, transition functions, idempotency utilities.
- E2E: generate → approve → schedule → publish; retries/backoff; autopilot guardrails.
- RLS regression tests for new tables.

## Rollout

- Feature flag `ai_generation_transparent_flow`.
- Phase 1: Generator page + events + candidates + queue.
- Phase 2: Scheduler with guardrails/backoff/circuit breaker.
- Phase 3: Planners + optimization insights + Realtime events.

### To-dos

- [ ] Add tabs and navigation in posts/new (Compose | Generate with AI | Grounding | Policy)
- [ ] Implement startPostGeneration action; insert ai_generations(pending) with idempotency_key
- [ ] Create migrations for state columns, idempotency, ai_generation_events (+ RLS)
- [ ] Build generation worker to process ai_generations and write ai_generation_events
- [ ] Generator client shows live status/logs/JSON; actions to create candidate/schedule
- [ ] Implement scheduler with FOR UPDATE SKIP LOCKED, backoff, circuit breaker, adapter A/B
- [ ] Approval queue UI in (dashboard)/content with filters and bulk actions
- [ ] RLS and role-gate tests for new tables and actions
- [ ] E2E for manual/manual scheduled/AI-assisted/autopilot flows and guardrails